<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Notion Connection</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-box {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .success { color: #22c55e; }
        .error { color: #ef4444; }
        button {
            background: #8b5cf6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover {
            background: #7c3aed;
        }
        pre {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
        }
        #loading {
            display: none;
            color: #8b5cf6;
        }
    </style>
</head>
<body>
    <h1>üß™ Test de Conexi√≥n con Notion</h1>
    
    <div class="test-box">
        <h2>1. Verificaci√≥n de Configuraci√≥n</h2>
        <div id="config-check"></div>
    </div>
    
    <div class="test-box">
        <h2>2. Test de CORS Proxy</h2>
        <button onclick="testCorsProxy()">Probar corsproxy.io</button>
        <div id="cors-result"></div>
    </div>
    
    <div class="test-box">
        <h2>3. Test de Conexi√≥n a Notion</h2>
        <button onclick="testNotionConnection()">Probar Conexi√≥n</button>
        <div id="loading">‚è≥ Conectando...</div>
        <div id="notion-result"></div>
    </div>

    <div class="test-box">
        <h2>4. Test Directo (sin proxy)</h2>
        <button onclick="testDirectConnection()">Probar Directo</button>
        <div id="direct-result"></div>
    </div>

    <script src="assets/js/notion-config.js"></script>
    <script>
        const DATABASE_ID = window.NOTION_CONFIG?.databaseId || '';
        const NOTION_TOKEN = window.NOTION_CONFIG?.token || '';

        // 1. Verificar configuraci√≥n
        function checkConfig() {
            const result = document.getElementById('config-check');
            let html = '';
            
            if (window.NOTION_CONFIG) {
                html += '<p class="success">‚úÖ window.NOTION_CONFIG existe</p>';
            } else {
                html += '<p class="error">‚ùå window.NOTION_CONFIG no encontrado</p>';
                result.innerHTML = html;
                return;
            }

            if (NOTION_TOKEN) {
                html += `<p class="success">‚úÖ Token presente (${NOTION_TOKEN.length} caracteres)</p>`;
                html += `<p>Token inicia con: <code>${NOTION_TOKEN.substring(0, 10)}...</code></p>`;
                html += `<p>Token v√°lido: <strong>${NOTION_TOKEN.startsWith('ntn_') ? '‚úÖ S√ç' : '‚ùå NO'}</strong></p>`;
            } else {
                html += '<p class="error">‚ùå Token no encontrado</p>';
            }

            if (DATABASE_ID) {
                html += `<p class="success">‚úÖ Database ID presente</p>`;
                html += `<p>Database ID: <code>${DATABASE_ID}</code></p>`;
            } else {
                html += '<p class="error">‚ùå Database ID no encontrado</p>';
            }

            result.innerHTML = html;
        }

        // 2. Probar CORS proxy
        async function testCorsProxy() {
            const result = document.getElementById('cors-result');
            result.innerHTML = '<p>‚è≥ Probando corsproxy.io...</p>';

            try {
                const testUrl = 'https://corsproxy.io/?https://api.github.com';
                const response = await fetch(testUrl);
                const data = await response.json();
                
                result.innerHTML = `
                    <p class="success">‚úÖ CORS Proxy funciona correctamente</p>
                    <pre>${JSON.stringify(data, null, 2).substring(0, 200)}...</pre>
                `;
            } catch (error) {
                result.innerHTML = `
                    <p class="error">‚ùå Error con CORS Proxy: ${error.message}</p>
                    <p>El proxy corsproxy.io podr√≠a estar ca√≠do. Prueba alternativas:</p>
                    <ul>
                        <li>https://api.allorigins.win/raw?url=</li>
                        <li>https://cors-anywhere.herokuapp.com/</li>
                    </ul>
                `;
            }
        }

        // 3. Probar conexi√≥n a Notion con proxy
        async function testNotionConnection() {
            const result = document.getElementById('notion-result');
            const loading = document.getElementById('loading');
            
            if (!NOTION_TOKEN || !DATABASE_ID) {
                result.innerHTML = '<p class="error">‚ùå Falta configuraci√≥n de Notion</p>';
                return;
            }

            loading.style.display = 'block';
            result.innerHTML = '';

            try {
                const proxyUrl = 'https://corsproxy.io/?';
                const notionUrl = `https://api.notion.com/v1/databases/${DATABASE_ID}/query`;
                
                console.log('Probando URL:', notionUrl);
                console.log('Con proxy:', proxyUrl + encodeURIComponent(notionUrl));

                const response = await fetch(proxyUrl + encodeURIComponent(notionUrl), {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${NOTION_TOKEN}`,
                        'Notion-Version': '2022-06-28',
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        filter: {
                            property: 'Publicado',
                            checkbox: {
                                equals: true
                            }
                        },
                        sorts: [
                            {
                                property: 'Fecha',
                                direction: 'descending'
                            }
                        ]
                    })
                });

                console.log('Response status:', response.status);
                console.log('Response headers:', [...response.headers.entries()]);

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Error response:', errorText);
                    throw new Error(`HTTP ${response.status}: ${errorText.substring(0, 200)}`);
                }

                const data = await response.json();
                console.log('Datos recibidos:', data);

                result.innerHTML = `
                    <p class="success">‚úÖ Conexi√≥n exitosa con Notion</p>
                    <p>Posts encontrados: <strong>${data.results?.length || 0}</strong></p>
                    <pre>${JSON.stringify(data, null, 2).substring(0, 500)}...</pre>
                `;
            } catch (error) {
                console.error('Error completo:', error);
                result.innerHTML = `
                    <p class="error">‚ùå Error: ${error.message}</p>
                    <p>Verifica:</p>
                    <ul>
                        <li>El token tiene permisos sobre la base de datos</li>
                        <li>La integraci√≥n est√° conectada en Notion (‚Ä¢‚Ä¢‚Ä¢ ‚Üí Connections)</li>
                        <li>El Database ID es correcto</li>
                        <li>Las propiedades (Publicado, Fecha) existen en la DB</li>
                    </ul>
                `;
            } finally {
                loading.style.display = 'none';
            }
        }

        // 4. Prueba sin proxy (fallar√° por CORS pero veremos el error)
        async function testDirectConnection() {
            const result = document.getElementById('direct-result');
            result.innerHTML = '<p>‚è≥ Probando conexi√≥n directa...</p>';

            try {
                const notionUrl = `https://api.notion.com/v1/databases/${DATABASE_ID}/query`;
                
                const response = await fetch(notionUrl, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${NOTION_TOKEN}`,
                        'Notion-Version': '2022-06-28',
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        filter: {
                            property: 'Publicado',
                            checkbox: {
                                equals: true
                            }
                        }
                    })
                });

                const data = await response.json();
                result.innerHTML = `
                    <p class="success">‚úÖ Conexi√≥n directa funciona (no necesitas proxy)</p>
                    <pre>${JSON.stringify(data, null, 2).substring(0, 500)}...</pre>
                `;
            } catch (error) {
                result.innerHTML = `
                    <p class="error">‚ùå Error esperado (CORS): ${error.message}</p>
                    <p>Esto es normal - el navegador bloquea peticiones directas a Notion.</p>
                `;
            }
        }

        // Ejecutar verificaci√≥n al cargar
        checkConfig();
    </script>
</body>
</html>
